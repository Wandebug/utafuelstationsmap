<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>UTA Fuel Stations — Open in Google Maps for True Distance</title>
  <style>
    :root { --ink:#0f172a; --muted:#64748b; --line:#e2e8f0; --bg:#f8fafc; --brand:#111827; --pillbg:#eef2ff; --pillbd:#c7d2fe; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color:var(--ink); background:#fff; }
    header { padding:16px; background:#0f172a; color:#fff; }
    header h1 { margin:0 0 4px; font-size:18px; }
    header .sub { color:#cbd5e1; font-size:12px; }
    main { padding:16px; max-width: 960px; margin:0 auto; }

    /* controls */
    .seg { display:inline-flex; border:1px solid var(--line); border-radius:12px; overflow:hidden; background:#fff; }
    .seg button { padding:10px 14px; border:0; background:transparent; cursor:pointer; font-weight:600; color:var(--muted); }
    .seg button.active { background:#0f172a; color:#fff; }

    .panel { margin-top:12px; padding:12px; border:1px solid var(--line); border-radius:12px; background:#fff; }

    .row { display:grid; grid-template-columns: 1fr auto auto; gap:8px; margin-bottom:6px; }
    .row2 { display:grid; grid-template-columns: 1fr 1fr auto; gap:8px; margin-bottom:6px; }
    input[type="text"] { padding:10px 12px; border:1px solid var(--line); border-radius:10px; font-size:15px; }
    input[disabled] { background:#f1f5f9; color:#94a3b8; }
    button.go { padding:10px 12px; border:1px solid #334155; background:var(--brand); color:#fff; border-radius:10px; cursor:pointer; }

    .small { font-size:12px; color:var(--muted); }

    /* High‑visibility status banner (placed BELOW the search bars) */
    .status-banner { 
      display:flex; align-items:center; gap:10px; 
      padding:12px 14px; margin:8px 0 8px; 
      border:1px solid var(--line); border-radius:12px; 
      background: linear-gradient(180deg, #eef2ff, #f8fafc);
      box-shadow: 0 1px 0 #e5e7eb inset;
      font-size:14px; color:#111827; 
    }
    .status-banner .dot { width:12px; height:12px; border-radius:999px; background:#6366f1; box-shadow:0 0 0 3px rgba(99,102,241,.15); animation: blink 1s infinite; }
    .status-banner .tag { font-size:11px; padding:2px 8px; border-radius:999px; border:1px solid var(--pillbd); background:var(--pillbg); color:#3730a3; }
    .status-banner.ok { background:linear-gradient(180deg, #ecfdf5, #f8fafc); border-color:#a7f3d0; }
    .status-banner.ok .dot { background:#10b981; box-shadow:0 0 0 3px rgba(16,185,129,.15); }
    .status-banner.warn { background:linear-gradient(180deg, #fff7ed, #f8fafc); border-color:#fed7aa; }
    .status-banner.warn .dot { background:#f59e0b; box-shadow:0 0 0 3px rgba(245,158,11,.15); }

    @keyframes blink { 50% { opacity:.3 } }

    .result-item { border:1px solid var(--line); border-radius:10px; padding:12px; margin:10px 0; background:var(--bg); }
    .title { font-weight:700; }
    .muted { color:var(--muted); }
    .stack { display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
    .pill { display:inline-block; padding:8px 12px; border-radius:999px; background:var(--pillbg); border:1px solid var(--pillbd); color:#3730a3; font-size:12px; text-decoration:none; }

    details { margin-top:10px }
  </style>
</head>
<body>
  <header>
    <h1>Find Approved UTA Stations</h1>
    <div class="sub">For exact distance & ETA, we open Google Maps directly.</div>
  </header>

  <main>
    <!-- mode switch -->
    <div class="seg" role="tablist" aria-label="Search mode">
      <button id="tab-near" class="active" role="tab" aria-selected="true">Nearest</button>
      <button id="tab-route" role="tab" aria-selected="false">Along Route</button>
    </div>

    <!-- Nearest panel -->
    <div id="panel-near" class="panel" role="tabpanel" aria-labelledby="tab-near">
      <div class="row">
        <input id="addr" type="text" placeholder="Type driver address (e.g., 'Atoomweg, 3542 Utrecht, NL')" />
        <button id="go" class="go">Find</button>
        <button id="myloc" class="go" title="Use my GPS location">Use my location</button>
      </div>
      <div id="statusNear" class="status-banner warn" role="status" aria-live="polite">
        <span class="dot" aria-hidden="true"></span>
        <div>
          <div style="font-weight:700">Preparing stations…</div>
          <div class="small">Please wait for the fuel stations to load. Typing is enabled when ready.</div>
        </div>
        <span class="tag">Nearest</span>
      </div>
      <div id="results"></div>
    </div>

    <!-- Along Route panel -->
    <div id="panel-route" class="panel" role="tabpanel" aria-labelledby="tab-route" hidden>
      <div class="row2">
        <input id="start" type="text" placeholder="Start / current location" />
        <input id="end" type="text" placeholder="Destination address" />
        <button id="goRoute" class="go">Find along route</button>
      </div>
      <div id="statusRoute" class="status-banner warn" role="status" aria-live="polite">
        <span class="dot" aria-hidden="true"></span>
        <div>
          <div style="font-weight:700">Preparing stations…</div>
          <div class="small">Please wait for the fuel stations to load. Then enter start & destination and press Find.</div>
        </div>
        <span class="tag">Along Route</span>
      </div>
      <div id="resultsRoute"></div>
      <details>
        <summary class="small">How this works</summary>
        <div class="small">We geocode start & end (free service), draw a straight line between them, then list stations along the path (not by km). Open Google Maps to get true road distance/ETA.</div>
      </details>
    </div>

    <details>
      <summary class="small">What this shows (and why)</summary>
      <div class="small">
        We list the nearest 3 stations (Nearest tab) or the stations along your route (Along Route tab). We do <b>not</b> display km/ETA inside this page so that Google Maps remains the single, accurate source of truth.
      </div>
    </details>
  </main>

  <script>
    // --- Approved stations (with Google links) ---
    const STATIONS = [{'name': 'TruckEasyStation', 'address': 'Fahrenheitlaan 6 G, 9207 HE Drachten-Azeven', 'mapsLink': 'https://share.google/j23OoM7pePme3poOR'}, {'name': 'DCB EnergyStation', 'address': 'Flight Forum 3950, 5657 DX Eindhoven', 'mapsLink': 'https://share.google/GPOWtpAxfNsTv9xv0'}, {'name': 'DCB Energy', 'address': 'Rijksstraatweg 124, 3316 EJ Dordrecht', 'mapsLink': 'https://share.google/5lCW0b0pvrkZ4RsJv'}, {'name': 'TruckEasyStation', 'address': 'Schiedamsedijk 2, Vulcaanhaven, 3134 KK Vlaardingen', 'mapsLink': 'https://share.google/GwxL0n9VsdNfV9OUy'}, {'name': 'TruckEasyStation', 'address': 'Erik de Rodeweg 3, 5975 WD Venlo-Sevenum', 'mapsLink': 'https://share.google/uefUSkALZTSKQQdPb'}, {'name': 'TruckEasyStation', 'address': 'Kelzer Napoleonweg 11, 4272 LB Hank', 'mapsLink': 'https://share.google/ps14lcneSscVi08Uh'}, {'name': 'TruckEasyStation', 'address': 'Delta-Industrieweg 16, 3251 LX Stellendam', 'mapsLink': 'https://share.google/GM8EYTP8IPt4Mirs7'}, {'name': 'TruckEasyStation', 'address': 'Annavas 55, 4704 SC Roosendaal', 'mapsLink': 'https://share.google/5nv5ofk1Sf1uY7NhY'}, {'name': 'TruckEasyStation', 'address': 'Berkelse Poort 77, 2651 JX Berkel en Rodenrijs', 'mapsLink': 'https://share.google/L4tENdGMSep1bOTGQ'}, {'name': 'TankEasyStation', 'address': 'Kanaaldijk West 8, 3298 LM Zwartewaal', 'mapsLink': 'https://share.google/V0TUYiGYV77fXmMtd'}, {'name': 'TankEasyStation', 'address': 'De Grens 5, 6598 DK Gennep Heijen', 'mapsLink': 'https://share.google/mKNI6wVInAORN21v3'}, {'name': 'TruckEasyStation', 'address': 'Heuvelweg 13, 2716 KP Pijnacker', 'mapsLink': 'https://share.google/ls2ccAuJIkvgV7hGj'}, {'name': 'TruckEasyStation', 'address': 'Braziliëlaan 9 a, 1432 DG Aalsmeer', 'mapsLink': 'https://share.google/rPYHZDjdj6xHn76Q2'}, {'name': 'TruckEasyStation', 'address': 'Peuldreef 2, 2653 BX Den Hoorn', 'mapsLink': 'https://share.google/ASUjDzBRWAWFhWoLK'}, {'name': 'DCB EnergyStation', 'address': 'Vormerij 12, 7621 HL Borne', 'mapsLink': 'https://share.google/wI4tcf1scJv25WEJM'}, {'name': 'DCB Energy', 'address': 'Overslagweg 1, 2742 RJ Waddinxveen', 'mapsLink': 'https://share.google/haDCTswbdgITGy2M6'}, {'name': 'TankEasyStation', 'address': 'Karel Doormanstraat 1, 3181 VB Rozenburg', 'mapsLink': 'https://share.google/DD2dwqkQSY1WxMhj4'}, {'name': 'TruckEasyStation', 'address': 'Annavas 37, 4704 SC Roosendaal', 'mapsLink': 'https://share.google/WIozqRh7TyoDzcxyr'}, {'name': 'DCB EnergyStation', 'address': 'Moezelweg, Haven N. 5804, 3198 LS Maasvlakte-Europort', 'mapsLink': 'https://share.google/ut0YKAGz2m5avluk9'}, {'name': 'TankEasyStation', 'address': 'Thoelaverweg 2 a, 3231 KD Brielle', 'mapsLink': 'https://share.google/8OAdDLMddx2asJDSe'}, {'name': 'TruckEasyStation', 'address': 'Willem Barentszstraat 1 - 3, Distripark Eemhaven, 3165 AA Rotterdam-Albrandswaard', 'mapsLink': 'https://share.google/8r3vlAKLPD7ST2IPF'}, {'name': 'DCB EnergyStation', 'address': 'Changing Lane 10, 2132 MD Hoofddorp-Schiphol', 'mapsLink': 'https://share.google/KrKye3BCpcWVxYHzn'}, {'name': 'TruckEasyStation', 'address': 'IJsselstraat 3, 5347 KG Oss', 'mapsLink': 'https://share.google/AGSZTmfl9ZhoPdeSV'}, {'name': 'TruckEasyStation', 'address': 'Leorooiarostraat 50, Industrieterrein Gadering, 3194 AB Hoogvliet', 'mapsLink': 'https://share.google/RzVUSM3Sj5RwZZZtt'}, {'name': 'TruckEasyStation', 'address': 'Moerdijkseweg 1, 4765 SJ Zevenbergschen Hoek', 'mapsLink': 'https://share.google/5xj5lYaGFFq61CZVi'}, {'name': 'TruckEasyStation', 'address': 'Peuldreef 2, 2635 BX Den Hoorn', 'mapsLink': 'https://share.google/8ggorq8fQtD8wrun2'}, {'name': 'TruckEasyStation', 'address': 'Zaadmarkt 14, Veilingterrein WFO, 1681 PD Zwaagdijk', 'mapsLink': 'https://share.google/3u12kbAjjbufDM9Ua'}, {'name': 'TruckEasyStation', 'address': 'Braziliëlaan 2, 1432 DG Aalsmeer', 'mapsLink': 'https://share.google/AqAF9hcgcKco0qgFj'}, {'name': 'TruckEasyStation', 'address': 'Columbusboulevard 1, 3165 AD Rotterdam-Albrandswaard', 'mapsLink': 'https://share.google/Qr69iAyKBPO1J28l7'}, {'name': 'TruckEasyStation', 'address': 'Schiedamsedijk 12, 3134 KK Spijkenisse', 'mapsLink': 'https://share.google/XrV2i4itVCMz8xGBy'}, {'name': 'DCB EnergyStation', 'address': 'Burg. Grollemanweg 8, 9405 TN Assen', 'mapsLink': 'https://share.google/gpPs3znoBRnXDFHrd'}, {'name': 'TruckEasy', 'address': 'Moerdijkseweg 1, 4765 SJ Zevenbergense Hoek', 'mapsLink': 'https://share.google/wizUZNTbB0xk36BHi'}];

    // --- Free geocoder (no key) ---
    const PHOTON_URL = "https://photon.komoot.io/api/?q={q}&limit=1";

    const sleep = (ms) => new Promise(r => setTimeout(r, ms));
    const CACHE_KEY = "uta_station_coords_google_truth_v1";

    let stationsWithCoords = [];

    // UI helpers (banners)
    const statusNearEl = document.getElementById('statusNear');
    const statusRouteEl = document.getElementById('statusRoute');

    function setStatusNear(title, mode = 'warn', subText = '') {
      if (!statusNearEl) return;
      statusNearEl.classList.remove('ok','warn');
      statusNearEl.classList.add(mode);
      const titleEl = statusNearEl.querySelector('div > div:nth-child(1)');
      const subEl = statusNearEl.querySelector('div > div:nth-child(2)');
      if (titleEl) titleEl.textContent = title;
      if (subEl) subEl.textContent = subText || (mode === 'ok' ? 'Open any option to get true road distance & ETA in Google Maps.' : 'Typing is enabled when ready.');
    }
    function setStatusRoute(title, mode = 'warn', subText = '') {
      if (!statusRouteEl) return;
      statusRouteEl.classList.remove('ok','warn');
      statusRouteEl.classList.add(mode);
      const titleEl = statusRouteEl.querySelector('div > div:nth-child(1)');
      const subEl = statusRouteEl.querySelector('div > div:nth-child(2)');
      if (titleEl) titleEl.textContent = title;
      if (subEl) subEl.textContent = subText || (mode === 'ok' ? 'Showing all approved stations ordered along your path. Open one to continue in Google Maps.' : 'Enter start and destination, then press Find.');
    }

    function disableNearest(disabled) {
      document.getElementById('addr').disabled = disabled;
      document.getElementById('go').disabled = disabled;
      document.getElementById('myloc').disabled = disabled;
    }
    function disableRoute(disabled) {
      document.getElementById('start').disabled = disabled;
      document.getElementById('end').disabled = disabled;
      document.getElementById('goRoute').disabled = disabled;
    }

    function haversineKm(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat/2) ** 2 +
                Math.cos(lat1 * Math.PI/180) * Math.cos(lat2 * Math.PI/180) *
                Math.sin(dLon/2) ** 2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    // Distance from point P to segment AB (in km), and t (0..1) projection along AB
    function pointToSegmentInfo(A, B, P) {
      const R = 6371000; // m
      const toXY = (ref, Q) => {
        const lam0 = ref.lng * Math.PI/180, phi0 = ref.lat * Math.PI/180;
        const lam = Q.lng * Math.PI/180, phi = Q.lat * Math.PI/180;
        const x = (lam - lam0) * Math.cos((phi + phi0)/2) * R;
        const y = (phi - phi0) * R;
        return {x,y};
      };
      const a = toXY(A, A);
      const b = toXY(A, B);
      const p = toXY(A, P);
      const abx = b.x - a.x, aby = b.y - a.y;
      const apx = p.x - a.x, apy = p.y - a.y;
      const ab2 = abx*abx + aby*aby || 1; // avoid /0
      let t = (apx*abx + apy*aby)/ab2;
      t = Math.max(0, Math.min(1, t));
      const proj = { x: a.x + t*abx, y: a.y + t*aby };
      const dx = p.x - proj.x, dy = p.y - proj.y;
      const distKm = Math.sqrt(dx*dx + dy*dy)/1000;
      const alongKm = Math.sqrt((proj.x-a.x)**2 + (proj.y-a.y)**2)/1000;
      return { distKm, t, alongKm };
    }

    function extractLatLngFromMapsLink(url) {
      if (!url) return null;
      try {
        const decoded = decodeURIComponent(url);
        let m = decoded.match(/@(-?\d+\.\d+),(-?\d+\.\d+)/);
        if (m) return { lat: parseFloat(m[1]), lng: parseFloat(m[2]) };
        const u = new URL(decoded);
        const tryParams = ["q", "query", "destination"]; 
        for (const p of tryParams) {
          const val = u.searchParams.get(p);
          if (val && /-?\d+\.\d+\s*,\s*-?\d+\.\d+/.test(val)) {
            const [la, ln] = val.split(",");
            return { lat: parseFloat(la), lng: parseFloat(ln) };
          }
        }
        m = decoded.match(/\/dir\/(-?\d+\.\d+),(-?\d+\.\d+)/);
        if (m) return { lat: parseFloat(m[1]), lng: parseFloat(m[2]) };
      } catch (e) { }
      return null;
    }

    async function geocode(q) {
      const url = PHOTON_URL.replace("{q}", encodeURIComponent(q));
      try {
        const res = await fetch(url);
        if (!res.ok) return null;
        const data = await res.json();
        if (data && data.features && data.features[0]) {
          const [lng, lat] = data.features[0].geometry.coordinates;
          return { lat, lng };
        }
      } catch (e) { console.warn("Geocode error:", e); }
      return null;
    }

    async function geocodeStations() {
      let cache = {};
      try { cache = JSON.parse(localStorage.getItem(CACHE_KEY) || "{}"); } catch (e) {}
      stationsWithCoords = [];
      for (const s of STATIONS) {
        if (cache[s.mapsLink]) {
          stationsWithCoords.push({ ...s, lat: cache[s.mapsLink].lat, lng: cache[s.mapsLink].lng, source: cache[s.mapsLink].source });
          continue;
        }
        const parsed = extractLatLngFromMapsLink(s.mapsLink);
        if (parsed) {
          stationsWithCoords.push({ ...s, lat: parsed.lat, lng: parsed.lng, source: "link" });
          cache[s.mapsLink] = { lat: parsed.lat, lng: parsed.lng, source: "link" };
        } else {
          const res = await geocode(s.name + " " + s.address);
          if (res) {
            stationsWithCoords.push({ ...s, lat: res.lat, lng: res.lng, source: "geocode" });
            cache[s.mapsLink] = { lat: res.lat, lng: res.lng, source: "geocode" };
          }
        }
        setStatusNear('Preparing stations…', 'warn', 'Please wait for the fuel stations to load. Typing is enabled when ready.');
        setStatusRoute('Preparing stations…', 'warn', 'Please wait for the fuel stations to load. Then enter start & destination and press Find.');
      }
      localStorage.setItem(CACHE_KEY, JSON.stringify(cache));
      setStatusNear('Stations ready.', 'ok', 'Enter driver address, press Find, then open a result in Google Maps.');
      setStatusRoute('Stations ready.', 'ok', 'Enter start & destination, press Find, then choose a station to open Google Maps (origin → station → destination).');
    }

    function buildGmapsNavURL(originText, destLat, destLng) {
      const origin = encodeURIComponent(originText.trim());
      const destination = encodeURIComponent(destLat + "," + destLng);
      return `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${destination}&travelmode=driving`;
    }
    function buildGmapsViaURL(startText, viaLat, viaLng, endText) {
      const origin = encodeURIComponent(startText.trim());
      const destination = encodeURIComponent(endText.trim());
      const waypoint = encodeURIComponent(viaLat + "," + viaLng);
      return `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${destination}&waypoints=${waypoint}&travelmode=driving`;
    }

    function renderNearest(originText, top3) {
      const wrap = document.getElementById('results');
      wrap.innerHTML = '';
      top3.forEach((s, idx) => {
        const navUrl = buildGmapsNavURL(originText, s.lat, s.lng);
        const src = s.source === 'link' ? 'from link' : 'geocoded';
        const div = document.createElement('div');
        div.className = 'result-item';
        div.innerHTML = `
          <div class="title">${idx+1}) ${s.name}</div>
          <div class="muted">${s.address} · <span style="font-size:11px;border:1px solid var(--line);padding:2px 8px;border-radius:999px;">${src}</span></div>
          <div class="stack">
            <a class="pill" target="_blank" href="${navUrl}">Open in Google Maps (Navigate)</a>
            <a class="pill" target="_blank" href="${s.mapsLink}">Open station link</a>
          </div>
        `;
        wrap.appendChild(div);
      });
    }

    function renderRoute(startText, endText, items) {
      const wrap = document.getElementById('resultsRoute');
      wrap.innerHTML = '';
      if (!items.length) {
        setStatusRoute('No stations along this route.', 'warn', 'Try different start/destination or use the Nearest tab.');
        wrap.innerHTML = '<div class="small">No stations found.</div>';
        return;
      }
      items.forEach((s, idx) => {
        const viaUrl = buildGmapsViaURL(startText, s.lat, s.lng, endText);
        const src = s.source === 'link' ? 'from link' : 'geocoded';
        const div = document.createElement('div');
        div.className = 'result-item';
        div.innerHTML = `
          <div class="title">${idx+1}) ${s.name}</div>
          <div class="muted">${s.address} · <span style="font-size:11px;border:1px solid var(--line);padding:2px 8px;border-radius:999px;">${src}</span></div>
          <div class="stack">
            <a class="pill" target="_blank" href="${viaUrl}">Open in Google Maps (via this station)</a>
            <a class="pill" target="_blank" href="${s.mapsLink}">Open station link</a>
          </div>
        `;
        wrap.appendChild(div);
      });
    }

    async function computeNearestTop3(origin) {
      const scored = stationsWithCoords.map(s => ({ ...s, airKm: haversineKm(origin.lat, origin.lng, s.lat, s.lng) }));
      scored.sort((a,b) => a.airKm - b.airKm);
      return scored.slice(0,3);
    }

    async function handleFindFromText() {
      const raw = (document.getElementById('addr').value || '').trim();
      if (!raw) { setStatusNear('Type an address first.', 'warn', 'Example: "Atoomweg, 3542 Utrecht, NL"'); return; }
      disableNearest(true);
      setStatusNear('Searching…', 'warn', 'Locating the address and computing nearest approved stations.');
      const origin = await geocode(raw);
      if (!origin) { setStatusNear('Could not find that address.', 'warn', 'Try a fuller, more specific address.'); disableNearest(false); return; }
      const top3 = await computeNearestTop3(origin);
      setStatusNear('Results ready.', 'ok', 'Open any option to get true road distance & ETA in Google Maps.');
      renderNearest(raw, top3);
      disableNearest(false);
    }

    function handleUseMyLocation() {
      if (!navigator.geolocation) { setStatusNear('Geolocation not supported by your browser.', 'warn'); return; }
      disableNearest(true);
      setStatusNear('Getting your location…', 'warn', 'Computing nearest approved stations.');
      navigator.geolocation.getCurrentPosition(async (pos) => {
        const origin = { lat: pos.coords.latitude, lng: pos.coords.longitude };
        const originText = origin.lat.toFixed(6) + "," + origin.lng.toFixed(6);
        const top3 = await computeNearestTop3(origin);
        setStatusNear('Results ready.', 'ok', 'Open any option to get true road distance & ETA in Google Maps.');
        renderNearest(originText, top3);
        disableNearest(false);
      }, (err) => { setStatusNear('Location error', 'warn', err.message); disableNearest(false); }, { enableHighAccuracy: true, timeout: 8000 });
    }

    async function handleFindAlongRoute() {
      const sRaw = (document.getElementById('start').value || '').trim();
      const eRaw = (document.getElementById('end').value || '').trim();
      if (!sRaw || !eRaw) { setStatusRoute('Type start & destination first.', 'warn', 'Example: "2742 Waddinxveen, NL" and "3449 JK Woerden"'); return; }
      disableRoute(true);
      setStatusRoute('Searching route…', 'warn', 'Geocoding start & destination, then ordering all stations along your path.');
      const [S, E] = await Promise.all([geocode(sRaw), geocode(eRaw)]);
      if (!S || !E) { setStatusRoute('Could not geocode one of the addresses.', 'warn', 'Try being more specific (street, city, country).'); disableRoute(false); return; }
      // ONLY stations along the path (strict)
      const filtered = [];
      for (const st of stationsWithCoords) {
        const info = pointToSegmentInfo(S, E, st);
        if (info.distKm < 5 && info.t >= 0 && info.t <= 1) { // stations within the 5km corridor and on path
          filtered.push({ ...st, offsetKm: info.distKm, alongKm: info.alongKm, t: info.t });
        }
      }
      // if no stations along the route
      if (filtered.length === 0) {
        setStatusRoute('No stations along the highway.', 'warn', 'There are no petrol stations directly on the highway. You can try the Nearest tab for stations nearby.');
      }
      // sort by along-path order, then by small offset
      filtered.sort((a,b) => a.alongKm - b.alongKm || a.offsetKm - b.offsetKm);
      setStatusRoute('Results ready.', 'ok', 'Showing all approved stations ordered along your path. Open one to continue in Google Maps.');
      renderRoute(sRaw, eRaw, filtered);
      disableRoute(false);
    }

    // Tabs
    (function tabs(){
      const tabNear = document.getElementById('tab-near');
      const tabRoute = document.getElementById('tab-route');
      const panelNear = document.getElementById('panel-near');
      const panelRoute = document.getElementById('panel-route');
      tabNear.addEventListener('click', () => {
        tabNear.classList.add('active'); tabNear.setAttribute('aria-selected','true');
        tabRoute.classList.remove('active'); tabRoute.setAttribute('aria-selected','false');
        panelNear.hidden = false; panelRoute.hidden = true;
      });
      tabRoute.addEventListener('click', () => {
        tabRoute.classList.add('active'); tabRoute.setAttribute('aria-selected','true');
        tabNear.classList.remove('active'); tabNear.setAttribute('aria-selected','false');
        panelNear.hidden = true; panelRoute.hidden = false;
      });
    })();

    // Init
    (async function () {
      if (!STATIONS.length) {
        setStatusNear('No approved stations found.', 'warn');
        setStatusRoute('No stations loaded.', 'warn');
        return;
      }
      disableNearest(true); disableRoute(true);
      await geocodeStations();
      disableNearest(false); disableRoute(false);
      // handlers
      document.getElementById('go').addEventListener('click', handleFindFromText);
      document.getElementById('myloc').addEventListener('click', handleUseMyLocation);
      document.getElementById('addr').addEventListener('keydown', (e) => { if (e.key === 'Enter') handleFindFromText(); });
      document.getElementById('goRoute').addEventListener('click', handleFindAlongRoute);
      document.getElementById('start').addEventListener('keydown', (e) => { if (e.key === 'Enter') handleFindAlongRoute(); });
      document.getElementById('end').addEventListener('keydown', (e) => { if (e.key === 'Enter') handleFindAlongRoute(); });
    })();
  </script>
</body>
</html>
