<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>UTA Fuel Stations — Open in Google Maps for True Distance</title>
  <style>
    :root { --ink:#0f172a; --muted:#64748b; --line:#e2e8f0; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color:var(--ink);}
    header { padding:16px; background:#0f172a; color:#fff; }
    header h1 { margin:0 0 4px; font-size:18px; }
    header .sub { color:#cbd5e1; font-size:12px; }
    main { padding:16px; max-width: 860px; margin:0 auto; }
    .row { display:grid; grid-template-columns: 1fr auto auto; gap:8px; margin-bottom:10px; }
    input[type="text"] { padding:10px 12px; border:1px solid var(--line); border-radius:10px; font-size:15px; }
    button { padding:10px 12px; border:1px solid #334155; background:#111827; color:#fff; border-radius:10px; cursor:pointer; }
    .small { font-size:12px; color:var(--muted); }
    .result-item { border:1px solid var(--line); border-radius:10px; padding:12px; margin:10px 0; background:#f8fafc; }
    .title { font-weight:600; }
    .muted { color:var(--muted); }
    .stack { display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
    .pill { display:inline-block; padding:8px 12px; border-radius:999px; background:#eef2ff; border:1px solid #c7d2fe; color:#3730a3; font-size:12px; text-decoration:none; }
  </style>
</head>
<body>
  <header>
    <h1>Find Nearest Approved UTA Stations</h1>
    <div class="sub">For exact distance & ETA, we open Google Maps directly.</div>
  </header>

  <main>
    <div class="row">
      <input id="addr" type="text" placeholder="Type driver address (e.g., 'Atoomweg, 3542 Utrecht, NL')" />
      <button id="go">Find</button>
      <button id="myloc">Use my location</button>
    </div>
    <div class="small" id="status">Preparing stations…</div>
    <div id="results"></div>

    <details style="margin-top:10px">
      <summary class="small">What this shows (and why)</summary>
      <div class="small">
        We list the nearest 3 approved stations from your list. We do <b>not</b> show km/ETA here so that Google Maps is the single, accurate source of truth.
      </div>
    </details>
  </main>

  <script>
    // --- Approved stations (with Google links) ---
    const STATIONS = [{'name': 'TruckEasyStation', 'address': 'Fahrenheitlaan 6 G, 9207 HE Drachten-Azeven', 'mapsLink': 'https://share.google/j23OoM7pePme3poOR'}, {'name': 'DCB EnergyStation', 'address': 'Flight Forum 3950, 5657 DX Eindhoven', 'mapsLink': 'https://share.google/GPOWtpAxfNsTv9xv0'}, {'name': 'DCB Energy', 'address': 'Rijksstraatweg 124, 3316 EJ Dordrecht', 'mapsLink': 'https://share.google/5lCW0b0pvrkZ4RsJv'}, {'name': 'TruckEasyStation', 'address': 'Schiedamsedijk 2, Vulcaanhaven, 3134 KK Vlaardingen', 'mapsLink': 'https://share.google/GwxL0n9VsdNfV9OUy'}, {'name': 'TruckEasyStation', 'address': 'Erik de Rodeweg 3, 5975 WD Venlo-Sevenum', 'mapsLink': 'https://share.google/uefUSkALZTSKQQdPb'}, {'name': 'TruckEasyStation', 'address': 'Kelzer Napoleonweg 11, 4272 LB Hank', 'mapsLink': 'https://share.google/ps14lcneSscVi08Uh'}, {'name': 'TruckEasyStation', 'address': 'Delta-Industrieweg 16, 3251 LX Stellendam', 'mapsLink': 'https://share.google/GM8EYTP8IPt4Mirs7'}, {'name': 'TruckEasyStation', 'address': 'Annavas 55, 4704 SC Roosendaal', 'mapsLink': 'https://share.google/5nv5ofk1Sf1uY7NhY'}, {'name': 'TruckEasyStation', 'address': 'Berkelse Poort 77, 2651 JX Berkel en Rodenrijs', 'mapsLink': 'https://share.google/L4tENdGMSep1bOTGQ'}, {'name': 'TankEasyStation', 'address': 'Kanaaldijk West 8, 3298 LM Zwartewaal', 'mapsLink': 'https://share.google/V0TUYiGYV77fXmMtd'}, {'name': 'TankEasyStation', 'address': 'De Grens 5, 6598 DK Gennep Heijen', 'mapsLink': 'https://share.google/mKNI6wVInAORN21v3'}, {'name': 'TruckEasyStation', 'address': 'Heuvelweg 13, 2716 KP Pijnacker', 'mapsLink': 'https://share.google/ls2ccAuJIkvgV7hGj'}, {'name': 'TruckEasyStation', 'address': 'Braziliëlaan 9 a, 1432 DG Aalsmeer', 'mapsLink': 'https://share.google/rPYHZDjdj6xHn76Q2'}, {'name': 'TruckEasyStation', 'address': 'Peuldreef 2, 2653 BX Den Hoorn', 'mapsLink': 'https://share.google/ASUjDzBRWAWFhWoLK'}, {'name': 'DCB EnergyStation', 'address': 'Vormerij 12, 7621 HL Borne', 'mapsLink': 'https://share.google/wI4tcf1scJv25WEJM'}, {'name': 'DCB Energy', 'address': 'Overslagweg 1, 2742 RJ Waddinxveen', 'mapsLink': 'https://share.google/haDCTswbdgITGy2M6'}, {'name': 'TankEasyStation', 'address': 'Karel Doormanstraat 1, 3181 VB Rozenburg', 'mapsLink': 'https://share.google/DD2dwqkQSY1WxMhj4'}, {'name': 'TruckEasyStation', 'address': 'Annavas 37, 4704 SC Roosendaal', 'mapsLink': 'https://share.google/WIozqRh7TyoDzcxyr'}, {'name': 'DCB EnergyStation', 'address': 'Moezelweg, Haven N. 5804, 3198 LS Maasvlakte-Europort', 'mapsLink': 'https://share.google/ut0YKAGz2m5avluk9'}, {'name': 'TankEasyStation', 'address': 'Thoelaverweg 2 a, 3231 KD Brielle', 'mapsLink': 'https://share.google/8OAdDLMddx2asJDSe'}, {'name': 'TruckEasyStation', 'address': 'Willem Barentszstraat 1 - 3, Distripark Eemhaven, 3165 AA Rotterdam-Albrandswaard', 'mapsLink': 'https://share.google/8r3vlAKLPD7ST2IPF'}, {'name': 'DCB EnergyStation', 'address': 'Changing Lane 10, 2132 MD Hoofddorp-Schiphol', 'mapsLink': 'https://share.google/KrKye3BCpcWVxYHzn'}, {'name': 'TruckEasyStation', 'address': 'IJsselstraat 3, 5347 KG Oss', 'mapsLink': 'https://share.google/AGSZTmfl9ZhoPdeSV'}, {'name': 'TruckEasyStation', 'address': 'Leorooiarostraat 50, Industrieterrein Gadering, 3194 AB Hoogvliet', 'mapsLink': 'https://share.google/RzVUSM3Sj5RwZZZtt'}, {'name': 'TruckEasyStation', 'address': 'Moerdijkseweg 1, 4765 SJ Zevenbergschen Hoek', 'mapsLink': 'https://share.google/5xj5lYaGFFq61CZVi'}, {'name': 'TruckEasyStation', 'address': 'Peuldreef 2, 2635 BX Den Hoorn', 'mapsLink': 'https://share.google/8ggorq8fQtD8wrun2'}, {'name': 'TruckEasyStation', 'address': 'Zaadmarkt 14, Veilingterrein WFO, 1681 PD Zwaagdijk', 'mapsLink': 'https://share.google/3u12kbAjjbufDM9Ua'}, {'name': 'TruckEasyStation', 'address': 'Braziliëlaan 2, 1432 DG Aalsmeer', 'mapsLink': 'https://share.google/AqAF9hcgcKco0qgFj'}, {'name': 'TruckEasyStation', 'address': 'Columbusboulevard 1, 3165 AD Rotterdam-Albrandswaard', 'mapsLink': 'https://share.google/Qr69iAyKBPO1J28l7'}, {'name': 'TruckEasyStation', 'address': 'Schiedamsedijk 12, 3134 KK Spijkenisse', 'mapsLink': 'https://share.google/XrV2i4itVCMz8xGBy'}, {'name': 'DCB EnergyStation', 'address': 'Burg. Grollemanweg 8, 9405 TN Assen', 'mapsLink': 'https://share.google/gpPs3znoBRnXDFHrd'}, {'name': 'TruckEasy', 'address': 'Moerdijkseweg 1, 4765 SJ Zevenbergense Hoek', 'mapsLink': 'https://share.google/wizUZNTbB0xk36BHi'}];

    // --- Free geocoder (no key) ---
    const PHOTON_URL = "https://photon.komoot.io/api/?q={q}&limit=1";

    const sleep = (ms) => new Promise(r => setTimeout(r, ms));
    const CACHE_KEY = "uta_station_coords_google_truth_v1";

    let stationsWithCoords = [];

    function setStatus(html) { document.getElementById('status').innerHTML = html; }

    function haversineKm(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat/2) ** 2 +
                Math.cos(lat1 * Math.PI/180) * Math.cos(lat2 * Math.PI/180) *
                Math.sin(dLon/2) ** 2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    // Extract exact lat/lng from a Google Maps link if present
    function extractLatLngFromMapsLink(url) {
      if (!url) return null;
      try {
        const decoded = decodeURIComponent(url);

        // Pattern A: ".../@lat,lng,"
        let m = decoded.match(/@(-?\d+\.\d+),(-?\d+\.\d+)/);
        if (m) return { lat: parseFloat(m[1]), lng: parseFloat(m[2]) };

        const u = new URL(decoded);

        // Pattern B: q=lat,lng  or query=lat,lng  or destination=lat,lng
        const tryParams = ["q", "query", "destination"];
        for (const p of tryParams) {
          const val = u.searchParams.get(p);
          if (val && /-?\d+\.\d+\s*,\s*-?\d+\.\d+/.test(val)) {
            const [la, ln] = val.split(",");
            return { lat: parseFloat(la), lng: parseFloat(ln) };
          }
        }

        // Pattern C: dir segment with coordinates ".../dir/lat,lng/..."
        m = decoded.match(/\/dir\/(-?\d+\.\d+),(-?\d+\.\d+)/);
        if (m) return { lat: parseFloat(m[1]), lng: parseFloat(m[2]) };

      } catch (e) { }
      return null;
    }

    async function geocode(query) {
      const url = PHOTON_URL.replace("{q}", encodeURIComponent(query));
      try {
        const res = await fetch(url);
        if (!res.ok) return null;
        const data = await res.json();
        if (data && data.features && data.features[0]) {
          const [lng, lat] = data.features[0].geometry.coordinates;
          return { lat, lng };
        }
      } catch (e) { console.warn("Geocode error:", e); }
      return null;
    }

    async function geocodeStations() {
      // Prefer exact coords from the station Google link; else geocode address
      let cache = {};
      try { cache = JSON.parse(localStorage.getItem(CACHE_KEY) || "{}"); } catch (e) {}
      stationsWithCoords = [];
      let exact = 0, geo = 0, i = 0;
      for (const s of STATIONS) {
        i++;
        if (cache[s.mapsLink]) {
          stationsWithCoords.push({ ...s, lat: cache[s.mapsLink].lat, lng: cache[s.mapsLink].lng, source: cache[s.mapsLink].source });
          continue;
        }
        const parsed = extractLatLngFromMapsLink(s.mapsLink);
        if (parsed) {
          stationsWithCoords.push({ ...s, lat: parsed.lat, lng: parsed.lng, source: "link" });
          cache[s.mapsLink] = { lat: parsed.lat, lng: parsed.lng, source: "link" };
          exact++;
        } else {
          const res = await geocode(s.name + " " + s.address);
          if (res) {
            stationsWithCoords.push({ ...s, lat: res.lat, lng: res.lng, source: "geocode" });
            cache[s.mapsLink] = { lat: res.lat, lng: res.lng, source: "geocode" };
            geo++;
          }
        }
        setStatus(`Preparing stations… exact coords: <b>${exact}</b>, geocoded: <b>${geo}</b> (${i}/${STATIONS.length})`);
        await sleep(180);
      }
      localStorage.setItem(CACHE_KEY, JSON.stringify(cache));
      setStatus(`Stations ready. Enter driver address and click Find.`);
    }

    function buildGmapsNavURL(originText, destLat, destLng) {
      const origin = encodeURIComponent(originText.trim());
      const destination = encodeURIComponent(destLat + "," + destLng);
      return `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${destination}&travelmode=driving`;
    }

    function renderResults(originText, top3) {
      const wrap = document.getElementById('results');
      wrap.innerHTML = '';
      top3.forEach((s, idx) => {
        const navUrl = buildGmapsNavURL(originText, s.lat, s.lng);
        const src = s.source === 'link' ? 'from link' : 'geocoded';
        const div = document.createElement('div');
        div.className = 'result-item';
        div.innerHTML = `
          <div class="title">${idx+1}) ${s.name}</div>
          <div class="muted">${s.address} · <span style="font-size:11px;border:1px solid var(--line);padding:2px 8px;border-radius:999px;">${src}</span></div>
          <div class="stack">
            <a class="pill" target="_blank" href="${navUrl}">Open in Google Maps (Navigate)</a>
            <a class="pill" target="_blank" href="${s.mapsLink}">Open station link</a>
          </div>
        `;
        wrap.appendChild(div);
      });
    }

    async function computeTop3(origin) {
      // Rank by simple air distance for selection only (we won't display km here)
      const scored = stationsWithCoords.map(s => ({ ...s, airKm: haversineKm(origin.lat, origin.lng, s.lat, s.lng) }));
      scored.sort((a,b) => a.airKm - b.airKm);
      return scored.slice(0,3);
    }

    async function handleFindFromText() {
      const raw = (document.getElementById('addr').value || '').trim();
      if (!raw) { setStatus('Type an address first.'); return; }
      setStatus('Locating address…');
      const origin = await geocode(raw);
      if (!origin) { setStatus('Could not find that address. Try a fuller address.'); return; }
      const top3 = await computeTop3(origin);
      setStatus('Open any option in Google Maps for exact distance & ETA.');
      renderResults(raw, top3);
    }

    function handleUseMyLocation() {
      if (!navigator.geolocation) { setStatus('Geolocation not supported by your browser.'); return; }
      setStatus('Getting your location…');
      navigator.geolocation.getCurrentPosition(async (pos) => {
        const origin = { lat: pos.coords.latitude, lng: pos.coords.longitude };
        // We'll still pass a readable origin text to Google (lat,lng works too)
        const originText = origin.lat.toFixed(6) + "," + origin.lng.toFixed(6);
        const top3 = await computeTop3(origin);
        setStatus('Open any option in Google Maps for exact distance & ETA.');
        renderResults(originText, top3);
      }, (err) => setStatus('Location error: ' + err.message), { enableHighAccuracy: true, timeout: 8000 });
    }

    (async function () {
      if (!STATIONS.length) { setStatus('No approved stations with links were found.'); return; }
      await geocodeStations();
      document.getElementById('go').addEventListener('click', handleFindFromText);
      document.getElementById('myloc').addEventListener('click', handleUseMyLocation);
      document.getElementById('addr').addEventListener('keydown', (e) => { if (e.key === 'Enter') handleFindFromText(); });
    })();
  </script>
</body>
</html>
